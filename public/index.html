<!DOCTYPE html>
<html ng-app="myApp">
<head lang="en">
    <meta charset="UTF-8">
    <title>Friend Finder Application</title>
    <link rel="stylesheet" href="css/base.css"/>
    <script src="bower_components/angular/angular.js"></script>
    <script>
        var app = angular.module('myApp', []).controller('MyController', function ($scope) {
            $scope.message = 'Hello';
        });

        app.controller('LandingController', function ($scope, User, Geolocation, Position) {
            $scope.user = null;

            User.validate().then(function (data) {
                console.log('Printing from the controller ... ');
                console.log(data);
                console.log('User.profile', User.profile);
                $scope.user = User.profile;
            });

            $scope.getLocation = function () {
                Geolocation.getPosition().then(function (data) {
                    console.log(data);
                    $scope.coords = data.coords;
                }, function (data) {
                    console.log(data);
                });
            };

            $scope.sendPosition = function () {
                Position.send();
            };


        });

        app.factory('User', function ($q, $http) {

            var _user = null;

            return {
                get profile() {
                    return _user;
                },
                // User service object
                validate: function () {
                    return $q(function (resolve, reject) {
                        $http.get('/validate').then(function (config) {
                            console.log('printing from the service ... ');
                            console.log(config.data);
                            resolve(config.data);
                            _user = config.data;
                        }, function (config) {
                            console.log(config);
                            // person is not authenticated, so redirect to /auth/google
                            window.location = 'http://localhost:3000/auth/google';
                        });
                    });
                }
            };
        });

        app.factory('Geolocation', function ($q) {
            return {
                getPosition: function () {
                    return $q(function (resolve, reject) {
                        // async oeprations here ...

                        navigator.geolocation.getCurrentPosition(function (position) {
                            resolve(position);
                        }, function () {
                            reject(arguments);
                        })

                    });
                }
            };
        });

        app.factory('Position', function (Geolocation, $http, User) {
            return {
                send: function () {
                    console.log('starting the position service ... ');
                    console.time('info');
                    // sending position information to the backend
                    Geolocation.getPosition().then(function(loc) {
                        var obj = {
                            gid: User.profile.id,
                            coords: {
                                latitude: loc.coords.latitude,
                                longitude: loc.coords.longitude
                            }
                        };
                        console.log('have access to the position ... ', obj);
                        $http.post('/position', obj).then(function (config) {
                            // success from the server
                            console.timeEnd('info');
                            console.log(config.data);
                        }, function (config) {
                            // error from the server
                            console.log('Failed to contact server ...', config);

                        });
                    });
                }
            };
        });

    </script>
</head>
<body>
    <div ng-controller="LandingController">
        <div>Logging in ... </div>

        <section ng-if="user">
            <h2>Friend Finder Application - Geolocation</h2>
            <button ng-click="getLocation()">Get Location</button>
            <button ng-click="sendPosition()">Send Position to Backend ... </button>
            <div class="panel" ng-if="coords">
                You are at: {{coords.latitude | number : 2}}, {{coords.longitude | number: 2}}
            </div>
        </section>

    </div>
</body>
</html>